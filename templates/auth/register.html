{% extends 'auth/auth_base.html' %}
{% load static i18n %}

{% block content %}
  <div class="min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-4xl">
      <!-- Logo -->
      <div class="bg-white text-center pt-6">
        <a href="/">
          <img src="/static/assets/images/logos/logo.svg" alt="Starchat" class="inline-block h-12 mb-3">
        </a>
        <p class="text-slate-600 dark:text-slate-300">Crie sua conta grátis e teste sem limites.</p>
      </div>

      <!-- Card -->
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm p-6 md:p-8">
        <form method="post" action="{% url 'auth:register' %}" novalidate
              onsubmit="document.getElementById('fullLoader').style.display='flex';" class="space-y-6">
          {% csrf_token %}

          {% if messages %}
            {% for msg in messages %}
              <div class="rounded-md px-4 py-3 text-sm bg-red-50 text-red-700 dark:bg-red-950/40 dark:text-red-200">{{ msg }}</div>
            {% endfor %}
          {% endif %}

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
            <!-- E-mail -->
            <div>
              <label for="id_email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "E‑mail" %}</label>
              <div class="flex items-stretch rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 bg-white dark:bg-slate-900 focus-within:ring-indigo-600">
                <span class="px-3 flex items-center text-slate-400"><span class="material-symbols-outlined">mail</span></span>
                <input type="email" id="id_email" name="{{ form.email.html_name }}"
                       class="w-full rounded-r-xl bg-transparent outline-none p-2 placeholder-slate-400 dark:placeholder-slate-500"
                       placeholder="{% trans 'seu@email.com' %}"
                       value="{{ form.email.value|default_if_none:'' }}" required/>
              </div>
              {% if form.email.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.email.errors.0 }}</p>
              {% endif %}
            </div>

            <!-- Tipo de Empresa -->
            <div>
              <label for="id_company_type" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Tipo de Empresa" %}</label>
              <div class="flex items-stretch rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 bg-white dark:bg-slate-900">
                <span class="px-3 flex items-center text-slate-400"><span class="material-symbols-outlined">storefront</span></span>
                <select id="id_company_type" name="{{ form.company_type.html_name }}"
                        class="w-full rounded-r-xl bg-transparent outline-none p-2 mr-2"
                        required>
                  {% for val,label in form.company_type.field.choices %}
                    <option value="{{ val }}" {% if form.company_type.value == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              {% if form.company_type.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.company_type.errors.0 }}</p>
              {% endif %}
            </div>

            <!-- Senha -->
            <div>
              <label for="id_password" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Senha" %}</label>
              <div class="flex items-stretch rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 bg-white dark:bg-slate-900">
                <span class="px-3 flex items-center text-slate-400"><span class="material-symbols-outlined">lock</span></span>
                <input type="password" id="id_password" name="{{ form.password.html_name }}"
                       class="w-full bg-transparent outline-none p-2 placeholder-slate-400 dark:placeholder-slate-500"
                       placeholder="{% trans 'Digite sua senha' %}" required/>
                <button type="button" id="togglePassword"
                        class="px-3 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
                  <span class="pt-2 material-symbols-outlined">visibility</span>
                </button>
              </div>
              {% if form.password.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.password.errors.0 }}</p>
              {% endif %}
              <div class="w-full mt-2 h-2 rounded bg-slate-200 dark:bg-slate-800">
                <div id="password-strength-bar" class="h-2 rounded transition-all" style="width:0%"></div>
              </div>
              <p id="password-strength-text" class="mt-1 text-xs text-slate-500 dark:text-slate-400"></p>
            </div>

            <!-- Confirmar Senha -->
            <div>
              <label for="id_confirm_password" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Confirmar Senha" %}</label>
              <div class="flex items-stretch rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 bg-white dark:bg-slate-900">
                <span class="px-3 flex items-center text-slate-400"><span class="material-symbols-outlined">lock</span></span>
                <input type="password" id="id_confirm_password" name="{{ form.confirm_password.html_name }}"
                       class="w-full bg-transparent outline-none p-2 placeholder-slate-400 dark:placeholder-slate-500"
                       placeholder="{% trans 'Confirme sua senha' %}" required/>
                <button type="button" id="toggleConfirmPassword"
                        class="px-3 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
                  <span class="pt-2 material-symbols-outlined">visibility</span>
                </button>
              </div>
              {% if form.confirm_password.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.confirm_password.errors.0 }}</p>
              {% endif %}
            </div>

            <!-- Nome da Empresa -->
            <div>
              <label for="id_company_name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Nome da Empresa" %}</label>
              <div class="flex items-stretch rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 bg-white dark:bg-slate-900">
                <span class="px-3 flex items-center text-slate-400"><span class="material-symbols-outlined">business</span></span>
                <input type="text" id="id_company_name" name="{{ form.company_name.html_name }}"
                       class="w-full bg-transparent outline-none p-2 placeholder-slate-400 dark:placeholder-slate-500"
                       placeholder="{% trans 'Digite o nome da empresa' %}"
                       value="{{ form.company_name.value|default_if_none:'' }}" required/>
              </div>
              {% if form.company_name.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.company_name.errors.0 }}</p>
              {% endif %}
            </div>

            <!-- CNPJ -->
            <div>
              <label for="id_cnpj" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "CNPJ" %}</label>
              <div class="flex items-stretch rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 bg-white dark:bg-slate-900">
                <span class="px-3 flex items-center text-slate-400"><span class="material-symbols-outlined">badge</span></span>
                <input type="text" id="id_cnpj" name="{{ form.cnpj.html_name }}"
                       class="w-full bg-transparent outline-none p-2 placeholder-slate-400 dark:placeholder-slate-500"
                       placeholder="00.000.000/0000-00"
                       value="{{ form.cnpj.value|default_if_none:'' }}" required/>
              </div>
              {% if form.cnpj.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.cnpj.errors.0 }}</p>
              {% endif %}
            </div>

            <!-- Telefone -->
            <div>
              <label for="id_phone" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Telefone" %}</label>
              <div class="flex items-stretch rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 bg-white dark:bg-slate-900">
                <span class="px-3 flex items-center text-slate-400"><span class="material-symbols-outlined">call</span></span>
                <input type="text" id="id_phone" name="{{ form.phone.html_name }}"
                       class="w-full bg-transparent outline-none p-2 placeholder-slate-400 dark:placeholder-slate-500"
                       placeholder="(00) 00000-0000"
                       value="{{ form.phone.value|default_if_none:'' }}" required/>
              </div>
              {% if form.phone.errors %}
                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.phone.errors.0 }}</p>
              {% endif %}
            </div>
          </div>

          <!-- Ações -->
          <div class="text-center">
            <button type="submit"
                    class="w-72 inline-flex items-center justify-center gap-1 px-6 py-2.5 rounded-xl
                           bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm transition">
              {% trans "Inscrever‑se" %}
              <span class="material-symbols-outlined">arrow_forward</span>
            </button>

            <div class="mt-3 text-sm">
              <span class="text-slate-600 dark:text-slate-400">{% trans "Já tem uma conta?" %}</span>
              <a href="{% url 'admin:login' %}" class="text-indigo-600 hover:text-indigo-700 ml-1">{% trans "Entrar" %}</a>
            </div>
            <div class="mt-2">
              <a href="{% url 'page:index' %}" class="text-sm text-slate-700 hover:text-slate-900 underline dark:text-slate-300 dark:hover:text-slate-100">
                {% trans "Voltar" %}
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="fullLoader">
    <div class="px-4 py-3 rounded-xl bg-white shadow text-slate-700 dark:bg-slate-800 dark:text-slate-200">
      {% trans "Carregando..." %}
    </div>
  </div>


{% endblock content %}

{% block extra_scripts %}
  <script>
    // Toggle de senha
    function wireToggle(btnId, inputId) {
      const btn = document.getElementById(btnId);
      const el  = document.getElementById(inputId);
      if (!btn || !el) return;
      btn.addEventListener('click', () => {
        const show = el.type === 'password';
        el.type = show ? 'text' : 'password';
        btn.querySelector('.material-symbols-outlined').textContent = show ? 'visibility_off' : 'visibility';
      });
    }
    wireToggle('togglePassword', 'id_password');
    wireToggle('toggleConfirmPassword', 'id_confirm_password');

    // Barra de força da senha
    (function () {
      const input = document.getElementById('id_password');
      const bar   = document.getElementById('password-strength-bar');
      const text  = document.getElementById('password-strength-text');
      if (!input || !bar) return;

      input.addEventListener('input', () => {
        const v = input.value || '';
        let s = 0;
        if (v.length >= 8) s++;
        if (/[A-Z]/.test(v)) s++;
        if (/[0-9]/.test(v)) s++;
        if (/[^A-Za-z0-9]/.test(v)) s++;
        const pct = (s / 4) * 100;
        bar.style.width = pct + '%';
        bar.style.backgroundColor = pct < 50 ? '#dc2626' : (pct < 75 ? '#f59e0b' : '#16a34a');

        if (!text) return;
        if (pct === 100) {
          text.textContent = '{{ _("Senha forte!") }}';
          text.className = 'mt-1 text-xs text-green-600';
        } else {
          const needs = [];
          if (v.length < 8) needs.push('{{ _("8 caracteres") }}');
          if (!/[A-Z]/.test(v)) needs.push('{{ _("letra maiúscula") }}');
          if (!/[0-9]/.test(v)) needs.push('{{ _("número") }}');
          if (!/[^A-Za-z0-9]/.test(v)) needs.push('{{ _("caractere especial") }}');
          text.textContent = '{{ _("Faltam:") }} ' + needs.join(', ');
          text.className = 'mt-1 text-xs text-slate-500';
        }
      });
    })();
  </script>
{% endblock extra_scripts %}
